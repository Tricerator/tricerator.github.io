<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Dungeon Runner ‚Äì ≈°koln√≠ verze</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: radial-gradient(circle at top, #222 0, #050608 60%);
      color: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1 {
      margin-top: 20px;
      letter-spacing: 2px;
      text-transform: uppercase;
      text-align: center;
    }

    #menu, #game {
      max-width: 900px;
      width: 100%;
      padding: 20px;
      box-sizing: border-box;
    }

    #menu {
      margin-top: 20px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
    }

    label {
      display: block;
      margin: 10px 0 4px;
      font-weight: 600;
    }

    select, button {
      font-size: 16px;
      padding: 8px 10px;
      border-radius: 6px;
      border: none;
      margin-bottom: 10px;
    }

    button {
      cursor: pointer;
      font-weight: 700;
    }

    button#startGame {
      margin-top: 10px;
      background: #4caf50;
      color: white;
    }

    button#startGame:hover {
      filter: brightness(1.1);
    }

    .hidden {
      display: none;
    }

    #hud {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      flex-wrap: wrap;
      font-size: 14px;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px 15px;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    #hud span {
      white-space: nowrap;
    }

    #controls {
      font-size: 14px;
      margin-bottom: 10px;
      background: rgba(0,0,0,0.6);
      padding: 8px 12px;
      border-radius: 8px;
    }

    #grid {
      display: grid;
      grid-template-columns: repeat(10, 40px);
      grid-template-rows: repeat(10, 40px);
      gap: 3px;
      margin-top: 10px;
      background: #111;
      padding: 6px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
    }

    .tile {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      background: #1c1c1c;
      font-size: 22px;
      user-select: none;
    }

    .tile.player {
      background: #264653;
    }

    .tile.monster {
      background: #8d2b2b;
    }

    .tile.chest {
      background: #8c6b2f;
    }

    .tile.exit {
      background: #205c20;
    }

    .tile.wall {
      background: #444;
    }

    .tile.empty {
      background: #181818;
      color: #444;
      font-size: 14px;
    }

    #log {
      margin-top: 10px;
      max-height: 150px;
      overflow-y: auto;
      font-size: 13px;
      background: rgba(0,0,0,0.7);
      padding: 8px 12px;
      border-radius: 8px;
    }

    #log p {
      margin: 2px 0;
    }

    #gameOverOverlay,
    #shopOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: white;
      z-index: 10;
      text-align: center;
      padding: 20px;
      box-sizing: border-box;
    }

    #gameOverOverlay button,
    #shopOverlay button {
      margin-top: 10px;
      background: #4caf50;
      color: white;
    }

    #shopItems {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 12px 0;
      max-width: 300px;
      width: 100%;
    }

    #shopItems button {
      width: 100%;
      background: #333;
    }
  </style>
</head>
<body>
  <h1>Dungeon Runner ‚Äì ≈°koln√≠ verze</h1>

  <!-- MENU: volba rasy a povol√°n√≠ -->
  <section id="menu">
    <p>Jednoduch√Ω dungeon, kde si ≈æ√°ci procviƒç√≠ ovl√°d√°n√≠ kl√°vesnice (WASD, ≈°ipky, mezern√≠k, ƒç√≠sla).</p>

    <label for="raceSelect">Rasa</label>
    <select id="raceSelect">
      <option value="human">ƒålovƒõk (+0 HP, +0 √∫tok)</option>
      <option value="elf">Elf (+0 HP, +2 √∫tok, ≈°√≠py)</option>
      <option value="orc">Ork (+5 HP, +0 √∫tok)</option>
    </select>

    <label for="classSelect">Povol√°n√≠</label>
    <select id="classSelect">
      <option value="warrior">V√°leƒçn√≠k (30 HP, 6 √∫tok, 2 obrana)</option>
      <option value="mage">M√°g (20 HP, 8 √∫tok, 0 obrana, mana)</option>
      <option value="rogue">Zlodƒõj (24 HP, 5 √∫tok, 1 obrana)</option>
    </select>

    <button id="startGame">Start hry</button>
  </section>

  <!-- HRA -->
  <section id="game" class="hidden">
    <div id="hud">
      <span id="hudLevel"></span>
      <span id="hudClassRace"></span>
      <span id="hudHp"></span>
      <span id="hudAttack"></span>
      <span id="hudWeapon"></span>
      <span id="hudGold"></span>
      <span id="hudResource"></span>
      <span id="hudKeys"></span>
    </div>

    <div id="controls">
      <strong>Ovl√°d√°n√≠:</strong>
      Pohyb: WASD nebo ≈°ipky | Bl√≠zk√Ω √∫tok: mezern√≠k (na sousedn√≠ monstrum) | Ability 1: kl√°vesa 1 (mal√© l√©ƒçen√≠) |  
      √ötok na d√°lku: kl√°vesa 2 ‚Äì M√°g = kouzlo (mana), Elf = ≈°√≠p.  
      C√≠l: zabij v≈°echna monstra, posb√≠rej zlato a dojdi ke dve≈ô√≠m üö™. Dve≈ôe se otev≈ôou a≈æ po vyƒçi≈°tƒõn√≠ dungeonu.
    </div>

    <div id="grid"></div>
    <div id="log"></div>
  </section>

  <!-- Game over -->
  <div id="gameOverOverlay">
    <h2 id="gameOverText"></h2>
    <button id="restartBtn">Hr√°t znovu</button>
  </div>

  <!-- Obchod po levelu -->
  <div id="shopOverlay">
    <h2>Obchod mezi levely</h2>
    <p id="shopInfo"></p>
    <div id="shopItems">
      <button data-action="hp"></button>
      <button data-action="atk"></button>
      <button data-action="def"></button>
      <button data-action="heal"></button>
    </div>
    <button id="nextLevelBtn">Dal≈°√≠ level ‚ñ∂</button>
  </div>

  <script>
    // ==== Hern√≠ stav ====
    const mapWidth = 10;
    const mapHeight = 10;

    const MONSTER_TYPES = [
      { name: 'Sliz',       hp: 10, attack: 3, symbol: 'üëæ' },
      { name: 'Kostlivec',  hp: 12, attack: 4, symbol: 'üíÄ' },
      { name: 'Netvor',     hp: 16, attack: 5, symbol: 'üëπ' }
    ];

    const player = {
      x: 0,
      y: 9,
      maxHp: 1,
      hp: 1,
      baseAttack: 1,
      defense: 0,
      weaponBonus: 0,
      className: "",
      raceName: "",
      maxMana: 0,
      mana: 0,
      arrows: 0,
      facing: { dx: 1, dy: 0 }
    };

    let monsters = [];
    let chests = [];
    let walls = [];
    const exit = { x: 9, y: 0 }; // v√Ωchod
    let keyPressCount = 0;
    let gameRunning = false;
    let level = 1;
    let gold = 0;

    const hudLevel   = document.getElementById('hudLevel');
    const hudClassRace = document.getElementById('hudClassRace');
    const hudHp      = document.getElementById('hudHp');
    const hudAttack  = document.getElementById('hudAttack');
    const hudWeapon  = document.getElementById('hudWeapon');
    const hudGold    = document.getElementById('hudGold');
    const hudResource = document.getElementById('hudResource');
    const hudKeys    = document.getElementById('hudKeys');
    const gridEl     = document.getElementById('grid');
    const logEl      = document.getElementById('log');
    const menuEl     = document.getElementById('menu');
    const gameEl     = document.getElementById('game');
    const gameOverOverlay = document.getElementById('gameOverOverlay');
    const gameOverText    = document.getElementById('gameOverText');

    const shopOverlay = document.getElementById('shopOverlay');
    const shopInfo    = document.getElementById('shopInfo');
    const shopItems   = document.getElementById('shopItems');
    const nextLevelBtn = document.getElementById('nextLevelBtn');

    // ==== Obchod ‚Äì inflace cen ====
    const SHOP_INFLATION = 1.4;
    const shopCosts = {
      hp: 10,
      atk: 10,
      def: 8,
      heal: 6
    };

    function updateShopButtons() {
      shopItems.querySelectorAll('button').forEach(btn => {
        const action = btn.dataset.action;
        if (action === 'hp') {
          btn.textContent = `+5 max HP (${shopCosts.hp} zlata)`;
        } else if (action === 'atk') {
          btn.textContent = `+2 z√°kladn√≠ √∫tok (${shopCosts.atk} zlata)`;
        } else if (action === 'def') {
          btn.textContent = `+1 obrana (${shopCosts.def} zlata)`;
        } else if (action === 'heal') {
          btn.textContent = `Vyl√©ƒçit na pln√© HP (${shopCosts.heal} zlata)`;
        }
      });
    }

    // ==== Pomocn√© funkce ====
    function log(msg) {
      const p = document.createElement('p');
      p.textContent = msg;
      logEl.appendChild(p);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateHud() {
      hudLevel.textContent = `Level: ${level}`;
      hudClassRace.textContent = `Postava: ${player.raceName} ${player.className}`;
      hudHp.textContent = `≈Ωivoty: ${player.hp}/${player.maxHp}`;
      const totalAttack = player.baseAttack + player.weaponBonus;
      hudAttack.textContent = `√ötok: ${totalAttack} (z√°kl. ${player.baseAttack}, zbra≈à +${player.weaponBonus})`;
      hudWeapon.textContent = player.weaponBonus > 0 ? `Zbra≈à: vylep≈°en√°` : `Zbra≈à: z√°kladn√≠`;
      hudGold.textContent = `Zlato: ${gold}`;

      let resText = '';
      if (player.maxMana > 0) {
        resText = `Mana: ${player.mana}/${player.maxMana}`;
      } else if (player.raceName === 'Elf') {
        resText = `≈†√≠py: ${player.arrows}`;
      }
      hudResource.textContent = resText;

      hudKeys.textContent = `Stisknut√© kl√°vesy: ${keyPressCount}`;
    }

    function isSamePos(a, b) {
      return a.x === b.x && a.y === b.y;
    }

    function isWall(x, y) {
      return walls.some(w => w.x === x && w.y === y);
    }

    function getMonsterAt(x, y) {
      return monsters.find(m => m.hp > 0 && m.x === x && m.y === y);
    }

    function getChestAt(x, y) {
      return chests.find(c => !c.opened && c.x === x && c.y === y);
    }

    function randomFreePositions(count, forbiddenPositions) {
      const all = [];
      for (let y = 0; y < mapHeight; y++) {
        for (let x = 0; x < mapWidth; x++) {
          const forbidden = forbiddenPositions.some(p => p.x === x && p.y === y);
          if (!forbidden) {
            all.push({ x, y });
          }
        }
      }
      // zam√≠chat
      for (let i = all.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [all[i], all[j]] = [all[j], all[i]];
      }
      return all.slice(0, count);
    }

    function initDungeon() {
      monsters = [];
      chests = [];
      walls = [];
      // Player start
      player.x = 0;
      player.y = 9;

      const baseForbidden = [{ x: player.x, y: player.y }, exit];

      // zdi ‚Äì poƒçet roste s levelem
      const wallCount = Math.min(20, 6 + level * 2);
      const wallPositions = randomFreePositions(wallCount, baseForbidden);
      walls = wallPositions;

      const forbidden = baseForbidden.concat(walls);

      // poƒçet monster a truhel dle levelu ‚Äì ƒç√≠m d√°l v√≠c a silnƒõj≈°√≠
      const monsterCount = Math.min(12, 3 + level * 2);
      const chestCount   = 2 + Math.floor(level / 2);

      const positions = randomFreePositions(monsterCount + chestCount, forbidden);
      const monsterPositions = positions.slice(0, monsterCount);
      const chestPositions   = positions.slice(monsterCount);

      monsterPositions.forEach((pos, i) => {
        const type = MONSTER_TYPES[Math.floor(Math.random() * MONSTER_TYPES.length)];
        // inflace nep≈ô√°tel s levelem
        const extraHp = (level - 1) * 5;                      // HP roste docela rychle
        const extraAtk = Math.floor((level - 1) / 1.5) + 1;   // √∫tok roste pomaleji
        monsters.push({
          x: pos.x,
          y: pos.y,
          hp: type.hp + Math.max(0, extraHp),
          attack: type.attack + Math.max(0, extraAtk),
          name: `${type.name} ${i + 1}`,
          symbol: type.symbol
        });
      });

      chestPositions.forEach((pos, i) => {
        chests.push({
          x: pos.x,
          y: pos.y,
          opened: false,
          bonus: 2 + level + i,           // + √∫tok
          gold: 5 + level * 2 + i * 2     // zlato
        });
      });

      logEl.innerHTML = "";
      log(`Vstoupil jsi do dungeon runneru ‚Äì level ${level}. Zabij v≈°echna monstra a pak dojdi ke dve≈ô√≠m.`);
    }

    function renderGrid() {
      gridEl.innerHTML = "";
      for (let y = 0; y < mapHeight; y++) {
        for (let x = 0; x < mapWidth; x++) {
          const tile = document.createElement('div');
          tile.classList.add('tile');

          let char = '';
          let extraClass = 'empty';

          if (player.x === x && player.y === y) {
            char = 'üßô';
            extraClass = 'player';
          } else if (isWall(x, y)) {
            char = 'üß±';
            extraClass = 'wall';
          } else {
            const m = getMonsterAt(x, y);
            const c = getChestAt(x, y);

            if (m) {
              char = m.symbol;
              extraClass = 'monster';
            } else if (c) {
              char = 'üí∞';
              extraClass = 'chest';
            } else if (exit.x === x && exit.y === y) {
              char = 'üö™';
              extraClass = 'exit';
            } else {
              char = '.';
              extraClass = 'empty';
            }
          }

          tile.textContent = char;
          tile.classList.add(extraClass);
          gridEl.appendChild(tile);
        }
      }
    }

    function endGame(text) {
      gameRunning = false;
      gameOverText.textContent = text;
      gameOverOverlay.style.display = 'flex';
    }

    // ==== Pohyb a melee √∫tok ====
    function tryMove(dx, dy) {
      if (!gameRunning) return;
      const newX = player.x + dx;
      const newY = player.y + dy;

      // mimo mapu
      if (newX < 0 || newX >= mapWidth || newY < 0 || newY >= mapHeight) {
        log("Narazil jsi do okraje dungeonu.");
        return;
      }

      // zdi ‚Äì nepr≈Øchodn√©
      if (isWall(newX, newY)) {
        log("Nar√°≈æ√≠≈° do zdi.");
        return;
      }

      const monster = getMonsterAt(newX, newY);
      if (monster) {
        // m√≠sto pohybu ‚Äì √∫tok na monstrum
        attackMonster(monster);
        return;
      }

      // skuteƒçn√Ω pohyb
      player.x = newX;
      player.y = newY;
      if (dx !== 0 || dy !== 0) {
        player.facing = { dx, dy };
      }
      log(`Posunul ses na (${player.x + 1}, ${player.y + 1}).`);

      const chest = getChestAt(player.x, player.y);
      if (chest) {
        chest.opened = true;
        player.weaponBonus += chest.bonus;
        gold += chest.gold;
        log(`Na≈°el jsi truhlu! Zbra≈à pos√≠lena o +${chest.bonus} √∫toku a z√≠sk√°v√°≈° ${chest.gold} zlata.`);
      }

      updateHud();
      renderGrid();

      // Dve≈ôe funguj√≠ a≈æ po zabit√≠ v≈°ech monster
      if (isSamePos(player, exit)) {
        const alive = monsters.some(m => m.hp > 0);
        if (alive) {
          log("Dve≈ôe jsou zamƒçen√©, dokud v dungeonu z≈Øst√°vaj√≠ monstra.");
        } else {
          log("Do≈°el jsi ke dve≈ô√≠m ‚Äì level dokonƒçen!");
          gameRunning = false;
          openShop();
          return;
        }
      }

      monstersAct();
    }

    function rewardGoldForKill(name) {
      const gain = 5 + Math.floor(Math.random() * 6) + level * 2;
      gold += gain;
      log(`${name} byl pora≈æen! Z√≠sk√°v√°≈° ${gain} zlata.`);
    }

    function attackMonster(monster) {
      if (!gameRunning) return;
      const totalAttack = player.baseAttack + player.weaponBonus;
      log(`√ötoƒç√≠≈° na ${monster.name} a d√°v√°≈° ${totalAttack} po≈°kozen√≠.`);
      monster.hp -= totalAttack;

      if (monster.hp <= 0) {
        rewardGoldForKill(monster.name);
      } else {
        log(`${monster.name} m√° je≈°tƒõ ${monster.hp} HP.`);
      }

      monstersAct();
      updateHud();
      renderGrid();
    }

    function monstersAct() {
      if (!gameRunning) return;
      monsters.forEach(m => {
        if (m.hp <= 0) return;

        const dx = player.x - m.x;
        const dy = player.y - m.y;
        const distance = Math.abs(dx) + Math.abs(dy);

        if (distance === 1) {
          // √∫tok
          const dmg = Math.max(0, m.attack - player.defense);
          player.hp -= dmg;
          log(`${m.name} tƒõ zas√°hl za ${dmg} po≈°kozen√≠!`);
          if (player.hp <= 0) {
            player.hp = 0;
            updateHud();
            endGame("Zem≈ôel jsi v dungeonu. :(");
          }
        } else {
          // jednoduch√© AI ‚Äì snaha p≈ôibl√≠≈æit se, respektuje zdi i ostatn√≠ monstra
          let stepX = 0, stepY = 0;
          if (Math.abs(dx) > Math.abs(dy)) {
            stepX = dx > 0 ? 1 : -1;
          } else if (dy !== 0) {
            stepY = dy > 0 ? 1 : -1;
          }

          const newX = m.x + stepX;
          const newY = m.y + stepY;
          const occupied = monsters.some(other => other !== m && other.hp > 0 &&
            other.x === newX && other.y === newY);

          if (!occupied &&
              newX >= 0 && newX < mapWidth &&
              newY >= 0 && newY < mapHeight &&
              !isWall(newX, newY) &&
              !(player.x === newX && player.y === newY)) {
            m.x = newX;
            m.y = newY;
          }
        }
      });
      updateHud();
      renderGrid();
    }

    // Ability: kl√°vesa 1 ‚Äì mal√© l√©ƒçen√≠
    function useAbility1() {
      if (!gameRunning) return;
      const heal = 4;
      if (player.hp >= player.maxHp) {
        log("Ability 1: U≈æ m√°≈° pln√© ≈æivoty.");
        return;
      }
      player.hp = Math.min(player.maxHp, player.hp + heal);
      log(`Ability 1: L√©ƒç√≠≈° se o ${heal} HP.`);
      updateHud();
    }

    // √ötok na d√°lku ‚Äì kl√°vesa 2
    function useRangedAttack() {
      if (!gameRunning) return;

      let dmg;
      let usedResource = false;

      if (player.className === 'M√°g') {
        const cost = 3;
        if (player.mana < cost) {
          log("Nem√°≈° dost many na kouzlo na d√°lku.");
          return;
        }
        player.mana -= cost;
        dmg = player.baseAttack + player.weaponBonus + 4;
        usedResource = true;
        log("Ses√≠l√°≈° kouzlo na d√°lku.");
      } else if (player.raceName === 'Elf') {
        const cost = 1;
        if (player.arrows < cost) {
          log("Do≈°ly ti ≈°√≠py.");
          return;
        }
        player.arrows -= cost;
        dmg = player.baseAttack + player.weaponBonus + 3;
        usedResource = true;
        log("Vyst≈ôelil jsi ≈°√≠p.");
      } else {
        log("Tvoje postava nem√° √∫tok na d√°lku.");
        return;
      }

      const dx = player.facing.dx;
      const dy = player.facing.dy;
      if (dx === 0 && dy === 0) {
        log("Nejsi otoƒçen√Ω ≈æ√°dn√Ωm smƒõrem. Nejd≈ô√≠v se pohn√≠.");
        if (usedResource) updateHud();
        return;
      }

      let x = player.x + dx;
      let y = player.y + dy;
      let hit = false;

      // range do 4 pol√≠, zastav√≠ se na zdi
      for (let r = 1; r <= 4; r++) {
        if (x < 0 || x >= mapWidth || y < 0 || y >= mapHeight) break;
        if (isWall(x, y)) break;

        const m = getMonsterAt(x, y);
        if (m) {
          log(`√ötok na d√°lku zasahuje ${m.name} za ${dmg} po≈°kozen√≠.`);
          m.hp -= dmg;
          if (m.hp <= 0) {
            rewardGoldForKill(m.name);
          } else {
            log(`${m.name} m√° je≈°tƒõ ${m.hp} HP.`);
          }
          hit = true;
          break;
        }
        x += dx;
        y += dy;
      }

      if (!hit) {
        log("√ötok na d√°lku nic netrefil.");
      }

      updateHud();
      renderGrid();
      monstersAct();
    }

    // ==== Obchod ====
    function openShop() {
      shopInfo.textContent = `Level ${level} dokonƒçen. M√°≈° ${gold} zlata. Vyber si vylep≈°en√≠ nebo pokraƒçuj d√°l.`;
      updateShopButtons();
      shopOverlay.style.display = 'flex';
      updateHud();
    }

    shopItems.addEventListener('click', (e) => {
      if (e.target.tagName !== 'BUTTON') return;
      const action = e.target.dataset.action;
      let cost = 0;

      if (action === 'hp') {
        cost = shopCosts.hp;
        if (gold >= cost) {
          gold -= cost;
          player.maxHp += 5;
          player.hp += 5;
          shopCosts.hp = Math.round(shopCosts.hp * SHOP_INFLATION);
          log("Kupuje≈°: +5 max HP (cena p≈ô√≠≈°tƒõ vy≈°≈°√≠).");
        } else {
          log("Nem√°≈° dost zlata na +5 max HP.");
        }
      } else if (action === 'atk') {
        cost = shopCosts.atk;
        if (gold >= cost) {
          gold -= cost;
          player.baseAttack += 2;
          shopCosts.atk = Math.round(shopCosts.atk * SHOP_INFLATION);
          log("Kupuje≈°: +2 z√°kladn√≠ √∫tok (cena p≈ô√≠≈°tƒõ vy≈°≈°√≠).");
        } else {
          log("Nem√°≈° dost zlata na +2 √∫tok.");
        }
      } else if (action === 'def') {
        cost = shopCosts.def;
        if (gold >= cost) {
          gold -= cost;
          player.defense += 1;
          shopCosts.def = Math.round(shopCosts.def * SHOP_INFLATION);
          log("Kupuje≈°: +1 obrana (cena p≈ô√≠≈°tƒõ vy≈°≈°√≠).");
        } else {
          log("Nem√°≈° dost zlata na +1 obranu.");
        }
      } else if (action === 'heal') {
        cost = shopCosts.heal;
        if (gold >= cost) {
          gold -= cost;
          player.hp = player.maxHp;
          shopCosts.heal = Math.round(shopCosts.heal * SHOP_INFLATION);
          log("Kupuje≈°: pln√© l√©ƒçen√≠ (cena p≈ô√≠≈°tƒõ vy≈°≈°√≠).");
        } else {
          log("Nem√°≈° dost zlata na l√©ƒçen√≠.");
        }
      }

      shopInfo.textContent = `Level ${level} dokonƒçen. M√°≈° ${gold} zlata.`;
      updateShopButtons();
      updateHud();
    });

    nextLevelBtn.addEventListener('click', () => {
      level += 1;
      player.hp = player.maxHp; // dal≈°√≠ level s pln√Ωmi HP
      if (player.maxMana > 0) {
        player.mana = player.maxMana;   // doplnƒõn√≠ many
      }
      if (player.raceName === 'Elf') {
        player.arrows += 3;             // trochu nov√Ωch ≈°√≠p≈Ø
      }
      shopOverlay.style.display = 'none';
      startLevel();
    });

    // ==== Obsluha kl√°ves ====
    window.addEventListener('keydown', (e) => {
      if (!gameRunning) return;

      keyPressCount++;
      // aby str√°nka nescrollovala ≈°ipkami/mezerou
      if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',
           'w','W','a','A','s','S','d','D',' ','1','2'].includes(e.key)) {
        e.preventDefault();
      }

      switch (e.key) {
        case 'ArrowUp':
        case 'w':
        case 'W':
          tryMove(0, -1);
          break;
        case 'ArrowDown':
        case 's':
        case 'S':
          tryMove(0, 1);
          break;
        case 'ArrowLeft':
        case 'a':
        case 'A':
          tryMove(-1, 0);
          break;
        case 'ArrowRight':
        case 'd':
        case 'D':
          tryMove(1, 0);
          break;
        case ' ':
          // mezern√≠k ‚Äì √∫tok na monstrum v sousedstv√≠ (naho≈ôe/dole/vlevo/vpravo)
          const neighbors = [
            { x: player.x + 1, y: player.y },
            { x: player.x - 1, y: player.y },
            { x: player.x, y: player.y + 1 },
            { x: player.x, y: player.y - 1 }
          ];
          const target = neighbors
            .map(pos => getMonsterAt(pos.x, pos.y))
            .find(m => m);
          if (target) {
            attackMonster(target);
          } else {
            log("≈Ω√°dn√© monstrum v dosahu √∫toku.");
          }
          break;
        case '1':
          useAbility1();
          break;
        case '2':
          useRangedAttack();
          break;
      }
      updateHud();
    });

    // ==== Start levelu ====
    function startLevel() {
      initDungeon();
      updateHud();
      renderGrid();
      gameRunning = true;
    }

    // ==== Start hry z menu ====
    document.getElementById('startGame').addEventListener('click', () => {
      const raceValue = document.getElementById('raceSelect').value;
      const classValue = document.getElementById('classSelect').value;

      // z√°kladn√≠ staty podle classy
      if (classValue === 'warrior') {
        player.maxHp = 30;
        player.baseAttack = 6;
        player.defense = 2;
        player.className = 'V√°leƒçn√≠k';
        player.maxMana = 0;
        player.mana = 0;
      } else if (classValue === 'mage') {
        player.maxHp = 20;
        player.baseAttack = 8;
        player.defense = 0;
        player.className = 'M√°g';
        player.maxMana = 10;
        player.mana = 10;
      } else if (classValue === 'rogue') {
        player.maxHp = 24;
        player.baseAttack = 5;
        player.defense = 1;
        player.className = 'Zlodƒõj';
        player.maxMana = 0;
        player.mana = 0;
      }

      // rasa
      if (raceValue === 'human') {
        player.raceName = 'ƒålovƒõk';
      } else if (raceValue === 'elf') {
        player.raceName = 'Elf';
        player.baseAttack += 2;
        player.arrows = 6;
      } else if (raceValue === 'orc') {
        player.raceName = 'Ork';
        player.maxHp += 5;
        player.arrows = 0;
      }

      player.hp = player.maxHp;
      player.weaponBonus = 0;
      player.facing = { dx: 1, dy: 0 }; // v√Ωchoz√≠ smƒõr doprava

      level = 1;
      gold = 0;
      keyPressCount = 0;

      // reset cen v obchodƒõ
      shopCosts.hp = 10;
      shopCosts.atk = 10;
      shopCosts.def = 8;
      shopCosts.heal = 6;

      gameOverOverlay.style.display = 'none';
      shopOverlay.style.display = 'none';

      menuEl.classList.add('hidden');
      gameEl.classList.remove('hidden');

      startLevel();
    });

    document.getElementById('restartBtn').addEventListener('click', () => {
      // n√°vrat do menu ‚Äì ≈æ√°k si m≈Ø≈æe znovu vybrat rasu a classu
      gameOverOverlay.style.display = 'none';
      gameEl.classList.add('hidden');
      menuEl.classList.remove('hidden');
    });
  </script>
</body>
</html>
