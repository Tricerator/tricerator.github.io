<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Lov ovoce</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #f0f0f0;
    }

    #hud {
        padding: 10px;
        background: #333;
        color: white;
        font-size: 18px;
        line-height: 1.4;
    }

    #gameArea {
        position: relative;
        width: 100vw;
        height: calc(100vh - 70px);
        background: #eee;
        overflow: hidden;
        cursor: crosshair;
    }

    .square {
        position: absolute;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 0, 0, 0.05); /* jemn√Ω hitbox */
        user-select: none;
    }

    /* LEVEL / GAME OVER OVERLAY */
    #levelOverlay {
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.85);
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 48px;
        font-weight: bold;
        z-index: 9000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s linear;
    }

    #levelOverlay.visible {
        opacity: 1;
        pointer-events: auto;
    }

    #levelText {
        text-align: center;
        padding: 20px;
        animation: none;
    }

    /* Animace textu v overlayi */
    #levelOverlay.visible #levelText {
        animation: popIn 1.0s ease-out;
    }

    @keyframes popIn {
        0%   { transform: scale(0.5); opacity: 0; }
        50%  { transform: scale(1.2); opacity: 1; }
        100% { transform: scale(1.0); opacity: 1; }
    }

    /* STARTOVAC√ç MENU ‚Äì v√Ωbƒõr re≈æimu */
    #modeOverlay {
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.9);
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    }

    #modeOverlay.hidden {
        display: none;
    }

    #modeContent {
        text-align: center;
        max-width: 90vw;
    }

    #modeContent h1 {
        margin-bottom: 10px;
        font-size: 40px;
    }

    #modeContent p {
        margin: 6px 0;
    }

    #modeContent .buttons {
        margin-top: 15px;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
    }

    #modeContent button {
        padding: 10px 18px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
    }

    #modeContent button[data-mode="basic"] {
        background: #4caf50;
        color: white;
    }

    #modeContent button[data-mode="advanced"] {
        background: #ff9800;
        color: white;
    }

    #modeContent button[data-mode="moving"] {
        background: #e91e63;
        color: white;
    }

    #modeContent .hint {
        margin-top: 12px;
        font-size: 14px;
        opacity: 0.8;
    }

    @media (max-width: 768px) {
        #hud {
            font-size: 14px;
        }
        #modeContent h1 {
            font-size: 30px;
        }
        #modeContent button {
            font-size: 14px;
        }
    }
</style>
</head>
<body>

<!-- STARTOVAC√ç MENU -->
<div id="modeOverlay">
    <div id="modeContent">
        <h1>Lov ovoce</h1>
        <p>Zvol si re≈æim hry:</p>
        <div class="buttons">
            <button data-mode="basic">üçÄ Zaƒç√°teƒçn√≠k</button>
            <button data-mode="advanced">üõ° Pokroƒçil√Ω</button>
            <button data-mode="moving">‚ö° Expert</button>
        </div>
    </div>
</div>

<div id="hud">
    ‚è± ƒåas: <span id="time">0.0</span> s  
    | üéØ Z√°sahy: <span id="hit">0</span>/<span id="total">0</span>
    | üî• √örove≈à: <span id="level">1</span> (ka≈æd√Ωch 10 z√°sah≈Ø)
    | üíó ≈Ωivoty: <span id="lives">10</span>
    <br>
   ‚≠ê Sk√≥re: <span id="score">0</span>
    | ‚ö° Combo: <span id="combo">0</span> (max: <span id="bestCombo">0</span>)
    | üèÜ Rekord: <span id="highscore">0</span>
    | üéÆ Re≈æim: <span id="modeLabel">-</span>
    <br>
    P = pauza (PC), dvoj≈•uk/dvouprst√Ω tap = pauza (mobil)
</div>

<div id="gameArea"></div>

<div id="levelOverlay">
    <div id="levelText"></div>
</div>

<!-- Zvuky (voliteln√© ‚Äì m≈Ø≈æe≈° nahradit nebo smazat) -->
<audio id="hitSound" src="hit.wav" preload="auto"></audio>
<audio id="missSound" src="miss.wav" preload="auto"></audio>

<script>
// --- RE≈ΩIM HRY -------------------------------------------------------------
const MODE_BASIC    = "basic";
const MODE_ADVANCED = "advanced";
const MODE_MOVING   = "moving";

let gameMode = null;  // nastav√≠ se po kliknut√≠ v menu

function isAdvancedMode() {
    return gameMode === MODE_ADVANCED || gameMode === MODE_MOVING;
}
function isMovingMode() {
    return gameMode === MODE_MOVING;
}

// --- STAV HRY -------------------------------------------------------------
let gameRunning           = false;
let waitingForLevelStart  = false;
let gameOver              = false;

let time   = 0;
let hit    = 0;
let total  = 0;
let level  = 1;

// sk√≥re a ≈æivoty
let score      = 0;
let combo      = 0;
let bestCombo  = 0;
const maxLives = 10;
let lives      = maxLives;

// highscore (localStorage)
let highscore = 0;
const HIGHSCORE_KEY_PREFIX = "fruitGameHighscore_";

let timerInterval = null;
let spawnInterval = null;

// po kolika z√°saz√≠ch se zvedne level
const HITS_PER_LEVEL = 10;

// z√°kladn√≠ parametry obt√≠≈ænosti ‚Äì POMALEJ≈†√ç START
let baseSpawnDelay = 1200;   // ms
let baseLifetime   = 3000;   // ms
let baseSquareSize = 80;     // px

const minSpawnDelay = 250;
const minLifetime   = 500;
const minSquareSize = 20;

// detekce "mal√© obrazovky"
const isSmallScreen = window.innerWidth < 768;

// pro mal√© displeje to trochu zlehƒç√≠me
if (isSmallScreen) {
    baseSquareSize = 100;
    baseLifetime   = 3200;
}

let spawnDelay = baseSpawnDelay;
let lifetime   = baseLifetime;
let squareSize = baseSquareSize;

// bezpeƒçn√° z√≥na dole na mobilu (aby ovoce nebylo u syst√©mov√Ωch tlaƒç√≠tek)
const bottomSafeZone = isSmallScreen ? 80 : 0;
const topSafeZone    = isSmallScreen ? 30 : 0;

// --- DOM prvky -------------------------------------------------------------
const timeEl      = document.getElementById("time");
const hitEl       = document.getElementById("hit");
const totalEl     = document.getElementById("total");
const levelEl     = document.getElementById("level");
const livesEl     = document.getElementById("lives");
const scoreEl     = document.getElementById("score");
const comboEl     = document.getElementById("combo");
const bestComboEl = document.getElementById("bestCombo");
const highscoreEl = document.getElementById("highscore");
const modeLabelEl = document.getElementById("modeLabel");
const gameArea    = document.getElementById("gameArea");

const levelOverlay = document.getElementById("levelOverlay");
const levelText    = document.getElementById("levelText");

const modeOverlay  = document.getElementById("modeOverlay");

const hitSound  = document.getElementById("hitSound");
const missSound = document.getElementById("missSound");

// Ovoce pro levely ‚Äì po≈ôad√≠: 1 = T≈òE≈†E≈á
const levelFruitEmojis = ["üçí","üçé","üçá","üçì","üçå","üçç","üçâ","ü•ù"];
const levelFruitNames  = ["T≈ôe≈°e≈à","Jablko","Hrozny","Jahoda","Ban√°n","Ananas","Meloun","Kiwi"];

// POWER-UPY (jen v pokroƒçil√Ωch re≈æimech) ‚Äì ƒåASTƒöJ≈†√ç
const GOLD_EMOJI  = "‚≠ê";
const HEART_EMOJI = "üíó";
const BOMB_EMOJI  = "üí£";

const GOLD_CHANCE  = 0.12; // 12 % v≈°ech spawn≈Ø = zlat√° hvƒõzda
const HEART_CHANCE = 0.05; // 5 % = srdce
const BOMB_CHANCE  = 0.15; // 15 % = bomba

// BOSS (jen v pokroƒçil√Ωch)
const BOSS_LEVEL_PERIOD  = 5;    // ka≈æd√Ω 5. level
const BOSS_BASE_HP       = 8;
const BOSS_TIME_LIMIT    = 8000; // ms
const BOSS_LIFE_PENALTY  = 3;

let inBossFight = false;
let bossHP      = 0;
let bossTimerId = null;
let bossIntro   = false; // pr√°vƒõ zobrazen√Ω boss√≠ √∫vod

// --- Pomocn√© funkce -------------------------------------------------------
function getFruitEmojiForLevel(l) {
    const idx = (l - 1) % levelFruitEmojis.length;
    return levelFruitEmojis[idx];
}

function getFruitNameForLevel(l) {
    const idx = (l - 1) % levelFruitNames.length;
    return levelFruitNames[idx];
}

function isBossLevel(l) {
    return isAdvancedMode() && l > 0 && l % BOSS_LEVEL_PERIOD === 0;
}

function getHighscoreKey() {
    return HIGHSCORE_KEY_PREFIX + (gameMode || "unknown");
}

function loadHighscore() {
    if (!gameMode) {
        highscore = 0;
        highscoreEl.textContent = "0";
        return;
    }
    try {
        const stored = localStorage.getItem(getHighscoreKey());
        highscore = stored ? parseInt(stored, 10) || 0 : 0;
    } catch (e) {
        highscore = 0;
    }
    highscoreEl.textContent = highscore;
}

function updateHighscoreIfNeeded() {
    if (!gameMode) return;
    if (score > highscore) {
        highscore = score;
        highscoreEl.textContent = highscore;
        try {
            localStorage.setItem(getHighscoreKey(), String(highscore));
        } catch (e) {
            // localStorage m≈Ø≈æe b√Ωt zak√°zan√© ‚Äì ignorujeme
        }
    }
}

// ---- ƒåASOM√çRA ----
function startTimer() {
    if (timerInterval) return;
    timerInterval = setInterval(() => {
        time += 0.1;
        timeEl.textContent = time.toFixed(1);
    }, 100);
}

function stopTimer() {
    clearInterval(timerInterval);
    timerInterval = null;
}

// ---- ZVUKY ----
function playSound(sound) {
    if (!sound) return;
    try {
        sound.currentTime = 0;
        sound.play();
    } catch (e) {
        // autoplay blok ‚Äì ignorujeme
    }
}

// ---- OBT√ç≈ΩNOST PODLE LEVELU ----
function applyDifficultyForLevel() {
    const l = Math.max(1, level);

    spawnDelay = Math.max(minSpawnDelay, baseSpawnDelay - (l - 1) * 70);
    lifetime   = Math.max(minLifetime,   baseLifetime   - (l - 1) * 160);
    squareSize = Math.max(minSquareSize, baseSquareSize - (l - 1) * 6);

    if (spawnInterval && !inBossFight) {
        startSpawning();
    }
}

// ---- LEVEL / GAME OVER / BOSS INTRO OVERLAY ----
function showLevelOverlay(levelNumber) {
    const emoji = getFruitEmojiForLevel(levelNumber);
    const name  = getFruitNameForLevel(levelNumber);

    let extra = "";
    if (levelNumber === 1) {
        extra = "<br><span style='font-size:0.4em;'>C√≠l: nasb√≠rej " + HITS_PER_LEVEL +
                " t≈ôe≈°n√≠. M√°≈° " + maxLives + " ≈æivot≈Ø.</span>";
    } else {
        extra = "<br><span style='font-size:0.4em;'>Ovoce je o nƒõco men≈°√≠ a rychlej≈°√≠.</span>";
    }

    levelText.innerHTML =
        "LEVEL " + levelNumber + " ‚Äì " + emoji + " " + name +
        "<br><span style='font-size:0.6em;'>Klikni / ≈•ukni pro start</span>" +
        extra;

    clearAllSquares();

    gameRunning = false;
    stopTimer();
    stopSpawning();

    waitingForLevelStart = true;
    gameOver = false;
    inBossFight = false;
    bossIntro = false;
    levelOverlay.classList.add("visible");
}

function showBossIntro(levelNumber) {
    // zastav√≠me bƒõ≈ænou hru, jen info obrazovka
    gameRunning = false;
    waitingForLevelStart = false;
    gameOver = false;
    inBossFight = false;
    bossIntro = true;

    stopTimer();
    stopSpawning();
    clearAllSquares();

    const emoji = "üëë";

    levelText.innerHTML =
        "BOSS LEVEL " + levelNumber + " " + emoji +
        "<br><span style='font-size:0.6em;'>Rychle klikej / t√°hni my≈°√≠ po korunƒõ,</span>" +
        "<br><span style='font-size:0.6em;'>dokud ji √∫plnƒõ nezniƒç√≠≈°.</span>" +
        "<br><span style='font-size:0.5em;'>Kdy≈æ to nestihne≈°, p≈ôijde≈° o " + BOSS_LIFE_PENALTY + " ≈æivoty.</span>" +
        "<br><br><span style='font-size:0.5em;'>Klikni / ≈•ukni pro zaƒç√°tek souboje.</span>";

    levelOverlay.classList.add("visible");
}

function showGameOver() {
    gameRunning = false;
    waitingForLevelStart = false;
    gameOver = true;
    inBossFight = false;
    bossIntro = false;

    stopTimer();
    stopSpawning();
    clearAllSquares();

    if (bossTimerId) {
        clearTimeout(bossTimerId);
        bossTimerId = null;
    }

    levelText.innerHTML =
        "KONEC HRY" +
        "<br><span style='font-size:0.6em;'>Sk√≥re: " + score + "</span>" +
        "<br><span style='font-size:0.6em;'>Rekord: " + highscore + "</span>" +
        "<br><span style='font-size:0.6em;'>Nejlep≈°√≠ combo: " + bestCombo + "</span>" +
        "<br><span style='font-size:0.6em;'>Z√°sahy: " + hit + "/" + total + "</span>" +
        "<br><br><span style='font-size:0.5em;'>Klikni / ≈•ukni pro novou hru (stejn√Ω re≈æim)</span>";

    levelOverlay.classList.add("visible");
}

function startLevelIfWaiting() {
    if (!waitingForLevelStart) return;

    waitingForLevelStart = false;
    levelOverlay.classList.remove("visible");

    gameRunning = true;
    startTimer();
    startSpawning();
}

function resetGame() {
    time  = 0;
    hit   = 0;
    total = 0;
    level = 1;
    score = 0;
    combo = 0;
    bestCombo = 0;
    lives = maxLives;

    inBossFight = false;
    bossIntro   = false;
    if (bossTimerId) {
        clearTimeout(bossTimerId);
        bossTimerId = null;
    }

    timeEl.textContent      = "0.0";
    hitEl.textContent       = "0";
    totalEl.textContent     = "0";
    levelEl.textContent     = level;
    scoreEl.textContent     = score;
    comboEl.textContent     = combo;
    bestComboEl.textContent = bestCombo;
    livesEl.textContent     = lives;

    // popisek re≈æimu v HUDu
    if (gameMode === MODE_BASIC) {
        modeLabelEl.textContent = "Zaƒç√°teƒçn√≠k";
    } else if (gameMode === MODE_ADVANCED) {
        modeLabelEl.textContent = "Pokroƒçil√Ω";
    } else if (gameMode === MODE_MOVING) {
        modeLabelEl.textContent = "Expert";
    } else {
        modeLabelEl.textContent = "-";
    }

    loadHighscore();
    applyDifficultyForLevel();
    showLevelOverlay(level);
}

// klik / ≈•uk na overlay
levelOverlay.addEventListener("pointerdown", () => {
    if (gameOver) {
        // nov√° hra ve stejn√©m re≈æimu
        resetGame();
        startLevelIfWaiting();
    } else if (bossIntro) {
        // pr√°vƒõ jsme na √∫vodu boss levelu
        bossIntro = false;
        levelOverlay.classList.remove("visible");

        gameRunning = true;
        startTimer();
        startBossFight();  // tady skuteƒçnƒõ spust√≠me bosse
    } else {
        // klasick√Ω level overlay
        startLevelIfWaiting();
    }
});

// --- MENU: v√Ωbƒõr re≈æimu ---------------------------------------------------
modeOverlay.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
        gameMode = btn.dataset.mode;
        modeOverlay.classList.add("hidden");
        resetGame();
    });
});

// ---- PAUZA ----
function togglePause() {
    if (waitingForLevelStart || gameOver || !gameMode || bossIntro) return; // v overlay pauzu ne≈ôe≈°√≠me

    if (gameRunning) {
        gameRunning = false;
        stopTimer();
    } else {
        gameRunning = true;
        startTimer();
    }
}

// PC: P = pauza
document.addEventListener("keydown", e => {
    if (e.key.toLowerCase() === "p") {
        togglePause();
    }
});

// Mobil: dvoj≈•uk do hrac√≠ plochy = pauza
let lastTapTime = 0;

function handleTapPause() {
    const now = Date.now();
    if (now - lastTapTime < 300) {
        togglePause();
        lastTapTime = 0;
    } else {
        lastTapTime = now;
    }
}

// Mobil: dvouprst√Ω tap (dvƒõma prsty najednou) = pauza
if (isSmallScreen) {
    window.addEventListener("touchstart", e => {
        if (e.touches.length >= 2) {
            e.preventDefault();
            togglePause();
        }
    }, { passive: false });
}

// ---- SK√ìRE / ≈ΩIVOTY ----
function updateComboDisplay() {
    comboEl.textContent     = combo;
    bestComboEl.textContent = bestCombo;
}

function registerHit() {
    hit++;
    hitEl.textContent = hit;

    combo++;
    if (combo > bestCombo) {
        bestCombo = combo;
    }
    updateComboDisplay();

    score += 10 * combo;
    scoreEl.textContent = score;
    updateHighscoreIfNeeded();

    playSound(hitSound);
    checkLevelUp();
}

function registerMiss() {
    // aby se p≈ôi pauze / overlayi / boss fightu nestrh√°valy ≈æivoty
    if (!gameRunning || gameOver || inBossFight || !gameMode) return;

    combo = 0;
    updateComboDisplay();

    if (lives > 0) {
        lives--;
        livesEl.textContent = lives;
        playSound(missSound);
        if (lives <= 0) {
            showGameOver();
        }
    }
}

// ---- BOSS FIGHT ----
function startBossFight() {
    if (gameOver || !isAdvancedMode()) return;

    inBossFight = true;
    clearAllSquares();
    stopSpawning();
    gameRunning = true;   // hra bƒõ≈æ√≠, ale nespawnuje norm√°ln√≠ ovoce

    spawnBoss();
}

function spawnBoss() {
    const boss = document.createElement("div");
    boss.className = "square";

    const bossSize = Math.max(squareSize * 2.2, 140);
    boss.style.width     = bossSize + "px";
    boss.style.height    = bossSize + "px";
    boss.style.fontSize  = (bossSize * 0.7) + "px";
    boss.style.background = "rgba(255,215,0,0.25)";

    boss.textContent = "üëë";
    boss.dataset.role = "boss";

    const x = (gameArea.clientWidth  - bossSize) / 2;
    const y = (gameArea.clientHeight - bossSize) / 3;

    boss.style.left = x + "px";
    boss.style.top  = y + "px";

    bossHP = BOSS_BASE_HP + Math.floor(level * 0.7);

    gameArea.appendChild(boss);

    function hitBoss() {
        if (!inBossFight || !gameRunning || gameOver) return;

        bossHP--;
        score += 25;
        scoreEl.textContent = score;
        updateHighscoreIfNeeded();
        playSound(hitSound);

        if (bossHP <= 0) {
            boss.remove();
            finishBossFight(true);
        }
    }

    boss.addEventListener("pointerdown", hitBoss);
    boss.addEventListener("pointerenter", hitBoss);

    bossTimerId = setTimeout(() => {
        if (inBossFight) {
            if (boss.parentElement) {
                boss.remove();
            }
            finishBossFight(false);
        }
    }, BOSS_TIME_LIMIT);
}

function finishBossFight(success) {
    inBossFight = false;

    if (bossTimerId) {
        clearTimeout(bossTimerId);
        bossTimerId = null;
    }

    if (success) {
        score += 300;
        scoreEl.textContent = score;
        updateHighscoreIfNeeded();
    } else {
        const penalty = BOSS_LIFE_PENALTY;
        combo = 0;
        updateComboDisplay();

        lives = Math.max(0, lives - penalty);
        livesEl.textContent = lives;

        if (lives <= 0) {
            showGameOver();
            return;
        }
    }

    if (!gameOver) {
        startSpawning();
    }
}

// ---- KONTROLA LEVELU PODLE SK√ìRE ----
function checkLevelUp() {
    const newLevel = Math.floor(hit / HITS_PER_LEVEL) + 1;
    if (newLevel > level) {
        level = newLevel;
        levelEl.textContent = level;
        applyDifficultyForLevel();

        if (isBossLevel(level)) {
            // m√≠sto okam≈æit√©ho boje nejd≈ô√≠v info obrazovka
            showBossIntro(level);
        } else {
            showLevelOverlay(level);
        }
    }
}

// ---- POHYB OVOCE (pro t≈ôet√≠ re≈æim) ----
function startFruitMovement(square) {
    if (!isMovingMode()) return;

    let x = parseFloat(square.style.left);
    let y = parseFloat(square.style.top);

    const speed = 0.7 + Math.random() * 0.8; // px / frame
    let dx = (Math.random() * 2 - 1) * speed;
    let dy = (Math.random() * 2 - 1) * speed;

    function step() {
        if (!square.parentElement || !gameRunning || gameOver || inBossFight || !isMovingMode()) {
            return;
        }

        x += dx;
        y += dy;

        const maxX = gameArea.clientWidth  - square.offsetWidth;
        const maxY = gameArea.clientHeight - square.offsetHeight - bottomSafeZone;
        const minY = topSafeZone;

        if (x < 0 || x > maxX) {
            dx = -dx;
            x = Math.max(0, Math.min(x, maxX));
        }
        if (y < minY || y > maxY) {
            dy = -dy;
            y = Math.max(minY, Math.min(y, maxY));
        }

        square.style.left = x + "px";
        square.style.top  = y + "px";

        requestAnimationFrame(step);
    }

    requestAnimationFrame(step);
}

// ---- MAL√ù ‚ÄûPOPUP‚Äú TEXT ----
function showFloatingText(text, x, y, color) {
    const el = document.createElement("div");
    el.textContent = text;
    el.style.position = "absolute";
    el.style.left = x + "px";
    el.style.top = y + "px";
    el.style.transform = "translate(-50%, 0)";
    el.style.fontSize = "18px";
    el.style.fontWeight = "bold";
    el.style.color = color || "#ffffff";
    el.style.textShadow = "0 0 4px rgba(0,0,0,0.8)";
    el.style.pointerEvents = "none";
    el.style.zIndex = 9999;
    el.style.opacity = "1";

    gameArea.appendChild(el);

    let opacity = 1;
    let dy = 0;

    function animate() {
        opacity -= 0.03;
        dy -= 0.7;
        el.style.opacity = opacity.toString();
        el.style.transform = "translate(-50%, " + dy + "px)";
        if (opacity <= 0) {
            el.remove();
        } else {
            requestAnimationFrame(animate);
        }
    }
    requestAnimationFrame(animate);
}

// ---- GENEROV√ÅN√ç OVOCE ----
function spawnSquare() {
    if (!gameRunning || gameOver || inBossFight || !gameMode) return;

    const square = document.createElement("div");
    square.className = "square";

    square.style.width  = squareSize + "px";
    square.style.height = squareSize + "px";
    square.style.fontSize = (squareSize * 0.6) + "px";

    let kind  = "normal";
    let emoji = getFruitEmojiForLevel(level);

    if (isAdvancedMode()) {
        const r = Math.random();
        if (r < GOLD_CHANCE) {
            kind  = "gold";
            emoji = GOLD_EMOJI;
        } else if (r < GOLD_CHANCE + HEART_CHANCE) {
            kind  = "heart";
            emoji = HEART_EMOJI;
        } else if (r < GOLD_CHANCE + HEART_CHANCE + BOMB_CHANCE) {
            kind  = "bomb";
            emoji = BOMB_EMOJI;
        }
    }

    square.dataset.kind = kind;
    square.textContent  = emoji;

    const areaW = gameArea.clientWidth  - squareSize;
    const maxH  = gameArea.clientHeight - squareSize - bottomSafeZone;
    const minY  = topSafeZone;
    const areaH = Math.max(0, maxH - minY);

    const x = Math.random() * Math.max(areaW, 0);
    const y = minY + (areaH > 0 ? Math.random() * areaH : 0);

    square.style.left = x + "px";
    square.style.top  = y + "px";

    total++;
    totalEl.textContent = total;

    let hitRegistered = false;

    function onHit() {
        if (hitRegistered || !gameRunning || gameOver || inBossFight || !gameMode) return;
        hitRegistered = true;

        const kind = square.dataset.kind || "normal";

        // sou≈ôadnice pro popup text (p≈ôed remove)
        const rect = square.getBoundingClientRect();
        const gaRect = gameArea.getBoundingClientRect();
        const fx = rect.left - gaRect.left + rect.width / 2;
        const fy = rect.top - gaRect.top;

        square.remove();

        // BOMBA: ≈æ√°dn√Ω z√°sah do sk√≥re, ale -2 ≈æivoty a combo pryƒç
        if (kind === "bomb" && isAdvancedMode()) {
            combo = 0;
            updateComboDisplay();

            showFloatingText("-2 ≈æivoty", fx, fy, "#ff4444");

            if (lives > 0) {
                lives = Math.max(0, lives - 2);
                livesEl.textContent = lives;
                playSound(missSound);
                if (lives <= 0) {
                    showGameOver();
                }
            }
            return;
        }

        // norm√°ln√≠ z√°sah (vƒçetnƒõ gold/heart)
        registerHit();

        if (isAdvancedMode()) {
            if (kind === "gold") {
                score += 150;
                scoreEl.textContent = score;
                updateHighscoreIfNeeded();
                showFloatingText("+150", fx, fy, "#ffd700");
            } else if (kind === "heart") {
                if (lives < maxLives) {
                    lives++;
                    livesEl.textContent = lives;
                    showFloatingText("+1 ≈æivot", fx, fy, "#66ff66");
                }
            }
        }
    }

    square.addEventListener("pointerenter", onHit);
    square.addEventListener("pointerdown", onHit);

    gameArea.appendChild(square);

    // pohyb ovoce jen v t≈ôet√≠m re≈æimu
    if (isMovingMode()) {
        startFruitMovement(square);
    }

    // POZOR: bomba p≈ôi timeoutu NEPENALIZUJE
    setTimeout(() => {
        if (square.parentElement) {
            const kind = square.dataset.kind || "normal";
            square.remove();
            if (kind !== "bomb") {
                // jen norm√°ln√≠/pozitivn√≠ ovoce je "miss"
                registerMiss();
            }
        }
    }, lifetime);
}

function startSpawning() {
    if (inBossFight || !gameMode) return;

    if (spawnInterval) {
        clearInterval(spawnInterval);
    }
    spawnInterval = setInterval(() => {
        spawnSquare();
    }, spawnDelay);
}

function stopSpawning() {
    if (spawnInterval) {
        clearInterval(spawnInterval);
        spawnInterval = null;
    }
}

// odstran√≠ v≈°echny aktu√°ln√≠ ƒçtverce (nap≈ô. p≈ôi zmƒõnƒõ levelu)
function clearAllSquares() {
    const squares = document.querySelectorAll(".square");
    squares.forEach(s => s.remove());
}

// ---- Klik/tap do hern√≠ plochy ----
gameArea.addEventListener("pointerdown", e => {
    if (isSmallScreen && e.pointerType === "touch") {
        handleTapPause();
    }

    if (!gameRunning && !waitingForLevelStart && !gameOver && !inBossFight && gameMode) {
        gameRunning = true;
        startTimer();
    }
});

// --- START: zobraz√≠ se menu, hra ƒçek√° na v√Ωbƒõr re≈æimu ---
modeLabelEl.textContent = "-";
highscoreEl.textContent = "0";
</script>


</body>
</html>
